<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ë¦¬ì‚¬ì´í´ë§ ê°€ì´ë“œ</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* ì „ì²´ body ìŠ¤íƒ€ì¼ ì •ì˜ */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            justify-content: center;
            align-items: center;
        }
        h1 {
            color: #286b36; /* ì§„í•œ ìƒ‰ìƒ ì½”ë“œ */
        }
        /* ì±„íŒ… ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        #chat-container {
            width: 600px;
            height: 900px;
            margin: 0 auto;
            position: relative;
            text-align: left;
        }
        
        /* ì±„íŒ…ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        #chat-box {
            height: 750px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }
        
        /* ê° ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
            position: relative;
        }
        
        /* ë§í’ì„  ìŠ¤íƒ€ì¼ */
        .bubble {
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }
        
        /* ì‚¬ìš©ì ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .user-message .bubble {
            background-color: #d4f7c4;
            margin-left: 10px;
        }
        
        /* ë´‡ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .bot-message .bubble {
            background-color: #e9f2e3;
            margin-right: 10px;
        }
        
        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .profile {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        /* ì‚¬ìš©ìì™€ ë´‡ í”„ë¡œí•„ ìœ„ì¹˜ ì„¤ì • */
        .user-profile {
            margin-left: 10px;
        }
        .bot-profile {
            margin-right: 10px;
        }
        
        /* ì—…ë¡œë“œëœ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        #uploaded-image {
            width: 80%;
            height: auto;
            margin-top: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            display: block;
            margin-left: auto;
            margin-right: 0;
        }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        #upload-area {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            margin: 0 auto;
        }
        
        /* ì‚¬ìš©ì ì…ë ¥ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #user-input {
            width: 80%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #upload-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #upload-button:hover {
            background-color: #45a049;
        }

        /* ì œëª© ìŠ¤íƒ€ì¼ */
        h2 {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-top: 10px;
        }

        /* í’ˆëª© ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .item-button {
            background-color: #d4f7c4;
            color: black; /* ê¸€ì”¨ ìƒ‰ìƒì„ ê²€ì •ìœ¼ë¡œ ì„¤ì • */
            border: none;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .item-button:hover {
            background-color: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <h2>â™»ï¸ìŠ¤ë§ˆíŠ¸ ë¦¬ì‚¬ì´í´ë§ ê°€ì´ë“œ</h2> <!-- ì œëª© ì„¤ì • -->
        
        <!-- ì±„íŒ…ë°•ìŠ¤ -->
        <div id="chat-box"></div>
        
        <!-- ì—…ë¡œë“œ ì˜ì—­: ì´ë¯¸ì§€ ì—…ë¡œë“œë¥¼ ìœ„í•œ ì…ë ¥ì°½ê³¼ ë²„íŠ¼ -->
        <div id="upload-area">
            <input type="file" id="user-input" accept=".jpg,.png" />
            <button id="upload-button" onclick="sendImage()">ì´ë¯¸ì§€ ì „ì†¡</button>
        </div>
    </div>

    <script src="/static/chat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
    <script>
        // Markdown ì»¨ë²„í„° ì´ˆê¸°í™”
        const converter = new showdown.Converter();
        
        // ë²„íŠ¼ì— í‘œì‹œë  í’ˆëª© ë¦¬ìŠ¤íŠ¸
        const items = ['ì±…ì', 'í¬ì¥ìƒì', 'ë§¥ì£¼ìº”', 'ìŒë£Œìˆ˜ìº”', 'í†µì¡°ë¦¼ìº”', 'í˜íŠ¸ë³‘', 'ë°€íìš©ê¸°', 'ì¥ë‚œê°', 
                       'ì§ê´€í˜•', 'í™˜í˜•', 'TV', 'ëƒ‰ì¥ê³ ', 'ì „ê¸°ë°¥ì†¥', 'ì²­ì†Œê¸°', 'ë³´í˜¸ì¬', 'ë§¥ì£¼ë³‘', 'ì†Œì£¼ë³‘'];

        // ì±„íŒ…ë°•ìŠ¤ì— ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
        function addMessageToChatBox(sender, message, imageSrc = null) {
            const chatBox = document.getElementById("chat-box");
            const messageElement = document.createElement("div");

            // ë©”ì‹œì§€ì˜ í´ë˜ìŠ¤ ì„¤ì • (ì‚¬ìš©ì ë˜ëŠ” ë´‡)
            messageElement.className = sender === "user" ? "message user-message" : "message bot-message";
            const profile = document.createElement("img");
            profile.className = "profile " + (sender === "user" ? "user-profile" : "bot-profile");
            profile.src = sender === "user" ? "/static/man.png" : "/static/recycle-symbol.png";

            messageElement.appendChild(profile);
            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.innerHTML = converter.makeHtml(message);
            messageElement.appendChild(bubble);
            chatBox.appendChild(messageElement);

            // ì—…ë¡œë“œëœ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ì¶”ê°€
            if (imageSrc) {
                const img = document.createElement("img");
                img.id = "uploaded-image";
                img.src = imageSrc;
                chatBox.appendChild(img);
            }

            // ìµœì‹  ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ì´ë¯¸ì§€ ì „ì†¡ í•¨ìˆ˜
        function sendImage() {
            const userInput = document.getElementById("user-input");
            const file = userInput.files[0];
            if (!file) return;

            // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ë° ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            const imageSrc = URL.createObjectURL(file);
            addMessageToChatBox("user", "ì´ë¯¸ì§€ë¥¼ ì „ì†¡í–ˆìŠµë‹ˆë‹¤.\n\n", imageSrc);

            // ì´ë¯¸ì§€ íŒŒì¼ ì„œë²„ë¡œ ì „ì†¡
            const formData = new FormData();
            formData.append("image", file);

            fetch("/send_image", {
                method: "POST",
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                addMessageToChatBox("bot", data.response + "\n\n");
                
                // ë´‡ì´ ì¸ì‹í•  ìˆ˜ ì—†ëŠ” í’ˆëª©ì´ë©´ ë²„íŠ¼ í‘œì‹œ
                if (data.response === "ì•Œ ìˆ˜ ì—†ëŠ” í’ˆëª©") {
                    showItemButtons();
                }
            })
            .catch(error => {
                console.error("Error:", error);
                addMessageToChatBox("bot", "ì´ë¯¸ì§€ë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ğŸ˜…. \n\n ì›í•˜ëŠ” í’ˆëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n\n");
                showItemButtons();
            });
        }

        // í’ˆëª© ë²„íŠ¼ í‘œì‹œ í•¨ìˆ˜
        function showItemButtons() {
            const buttonContainer = document.createElement("div");
            buttonContainer.className = "button-container";
            
            // ê° í’ˆëª© ë²„íŠ¼ ìƒì„± ë° ì¶”ê°€
            items.forEach(item => {
                const button = document.createElement("button");
                button.className = "item-button";
                button.textContent = item;
                button.onclick = () => selectItem(item);
                buttonContainer.appendChild(button);
            });
            
            document.getElementById("chat-box").appendChild(buttonContainer);
        }

        // ì‚¬ìš©ìê°€ í’ˆëª© ì„ íƒ ì‹œ ì²˜ë¦¬ í•¨ìˆ˜
        function selectItem(selectedItem) {
            addMessageToChatBox("user", `ì„ íƒí•œ í’ˆëª©: ${selectedItem}`);
            fetch("/select_item", {
                method: "POST",
                body: JSON.stringify({ selected_item: selectedItem }),
                headers: { "Content-Type": "application/json" }
            })
            .then(response => response.json())
            .then(data => addMessageToChatBox("bot", data.response))
            .catch(error => console.error("Error:", error));
        }
    </script>
</body>
</html>
